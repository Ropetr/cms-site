---
import Base from '../../layouts/Base.astro';
import BlockRenderer from '../../components/blocks/BlockRenderer.astro';
import { getPreviewPage } from '../../lib/api';

const { slug } = Astro.params;
const siteId = Astro.locals.siteId;

let page: any = null;
let sections: any[] = [];
let notFound = false;

try {
  const data = await getPreviewPage(slug as string, siteId);
  page = data.page || data;
  sections = data.sections || [];
  
  if (!page) {
    notFound = true;
  }
} catch (e) {
  console.error('Error fetching preview page:', e);
  notFound = true;
}

if (notFound) {
  return Astro.redirect('/404');
}

const isDraft = page?.status === 'draft';
---

<Base 
  title={page?.meta_title || page?.title}
  description={page?.meta_description}
  ogImage={page?.og_image}
>
  {/* Preview Banner */}
  <div class="preview-banner">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <span class="preview-text">
        Modo Preview {isDraft && <span class="draft-badge">Rascunho</span>}
      </span>
      <a href="javascript:window.close()" class="close-preview">Fechar Preview</a>
    </div>
  </div>

  {/* Page Header (optional) */}
  {page?.title && page?.type !== 'landing' && (
    <header class="page-header">
      <div class="container mx-auto px-4">
        <h1 class="page-title">{page.title}</h1>
      </div>
    </header>
  )}
  
  {/* Page Content */}
  {sections.length > 0 ? (
    <BlockRenderer sections={sections} />
  ) : (
    <section class="empty-page">
      <div class="container mx-auto px-4 text-center">
        <p class="text-gray-500">Esta pagina ainda nao tem conteudo.</p>
      </div>
    </section>
  )}
</Base>

<style>
  .preview-banner {
    background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 0.75rem 0;
    position: sticky;
    top: 0;
    z-index: 9999;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .preview-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .draft-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
  }
  
  .close-preview {
    color: white;
    text-decoration: underline;
    opacity: 0.9;
  }
  
  .close-preview:hover {
    opacity: 1;
  }
  
  .page-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, color-mix(in srgb, var(--color-primary) 80%, black) 100%);
    color: white;
    padding: 4rem 0;
    margin-bottom: 2rem;
  }
  
  .page-title {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 700;
    text-align: center;
  }
  
  .empty-page {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
